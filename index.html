<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#F5F0E8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Reader">
<meta name="mobile-web-app-capable" content="yes">
<title>Reader</title>

<!-- Fonts: Lora for body (warm serif), JetBrains Mono for code -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>

<!-- PWA Manifest inline -->
<script>
const manifestData = {
  name: "Markdown Reader",
  short_name: "Reader",
  description: "A beautiful focused markdown reader",
  start_url: "./",
  display: "standalone",
  background_color: "#F5F0E8",
  theme_color: "#F5F0E8",
  orientation: "portrait-primary",
  icons: [
    { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%23F5F0E8'/><text x='256' y='340' font-size='300' text-anchor='middle' font-family='Georgia,serif' fill='%231a1410'>M</text></svg>", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
  ]
};
const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(blob);
const link = document.createElement('link');
link.rel = 'manifest';
link.href = manifestURL;
document.head.appendChild(link);
</script>

<style>
  /* ‚îÄ‚îÄ‚îÄ Design Tokens ‚îÄ‚îÄ‚îÄ */
  :root {
    --paper: #F5F0E8;
    --paper-dark: #EDE7D9;
    --ink: #1a1410;
    --ink-soft: #3d3530;
    --ink-muted: #7a6f65;
    --ink-faint: #b5a99a;
    --accent: #8B4513;
    --accent-warm: #C1440E;
    --selection: rgba(139,69,19,0.15);
    --code-bg: #EDE7D9;
    --border: rgba(26,20,16,0.12);
    --shadow: rgba(26,20,16,0.08);
    
    --font-body: 'Lora', 'Georgia', serif;
    --font-display: 'Playfair Display', 'Georgia', serif;
    --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1.125rem;
    --text-lg: 1.25rem;
    --text-xl: 1.5rem;
    --text-2xl: 1.875rem;
    --text-3xl: 2.25rem;
    --text-4xl: 3rem;
    
    --leading-tight: 1.25;
    --leading-snug: 1.4;
    --leading-normal: 1.65;
    --leading-relaxed: 1.8;
    
    --measure: 68ch;
    --radius: 4px;
    --transition: 200ms ease;
  }

  [data-theme="dark"] {
    --paper: #171310;
    --paper-dark: #1f1b17;
    --ink: #F0EAE0;
    --ink-soft: #D4C9BB;
    --ink-muted: #8a7f74;
    --ink-faint: #4a4038;
    --accent: #D4895A;
    --accent-warm: #E8693A;
    --selection: rgba(212,137,90,0.2);
    --code-bg: #1f1b17;
    --border: rgba(240,234,224,0.1);
    --shadow: rgba(0,0,0,0.3);
  }

  /* ‚îÄ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ‚îÄ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
    scroll-behavior: smooth;
  }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: var(--leading-normal);
    min-height: 100dvh;
    transition: background var(--transition), color var(--transition);
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    font-feature-settings: "kern" 1, "liga" 1, "calt" 1, "onum" 1;
  }

  ::selection { background: var(--selection); }

  /* ‚îÄ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ‚îÄ */
  #topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    padding-top: max(12px, env(safe-area-inset-top));
    background: var(--paper);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  #app-title {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: -0.02em;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .toolbar-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border: none;
    background: none;
    color: var(--ink-muted);
    cursor: pointer;
    border-radius: var(--radius);
    transition: color var(--transition), background var(--transition);
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .toolbar-btn:hover, .toolbar-btn:active {
    color: var(--ink);
    background: var(--border);
  }

  .toolbar-btn svg { width: 20px; height: 20px; }

  /* ‚îÄ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ‚îÄ */
  #dropzone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: calc(100dvh - 60px);
    padding: 40px 24px;
    text-align: center;
    gap: 24px;
  }

  .drop-icon {
    font-size: 64px;
    opacity: 0.25;
    line-height: 1;
  }

  .drop-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--ink);
    letter-spacing: -0.03em;
    line-height: 1.2;
  }

  .drop-sub {
    color: var(--ink-muted);
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    max-width: 30ch;
  }

  .drop-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 13px 24px;
    background: var(--ink);
    color: var(--paper);
    border: none;
    border-radius: 100px;
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 600;
    cursor: pointer;
    transition: transform 100ms ease, opacity 150ms ease;
    -webkit-tap-highlight-color: transparent;
    letter-spacing: 0.02em;
  }

  .drop-btn:active { transform: scale(0.97); opacity: 0.85; }

  .drop-divider {
    display: flex;
    align-items: center;
    gap: 16px;
    width: 100%;
    max-width: 280px;
    color: var(--ink-faint);
    font-size: var(--text-xs);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .drop-divider::before, .drop-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .drop-url-row {
    display: flex;
    gap: 8px;
    width: 100%;
    max-width: 360px;
  }

  .url-input {
    flex: 1;
    padding: 11px 16px;
    background: var(--paper-dark);
    border: 1px solid var(--border);
    border-radius: 100px;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--ink);
    outline: none;
    transition: border-color var(--transition);
  }

  .url-input:focus { border-color: var(--accent); }
  .url-input::placeholder { color: var(--ink-faint); }

  .url-go {
    padding: 11px 18px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 100px;
    font-size: var(--text-xs);
    font-weight: 600;
    cursor: pointer;
    transition: opacity 150ms ease;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .url-go:active { opacity: 0.8; }

  .drag-over #dropzone {
    background: var(--selection);
    outline: 2px dashed var(--accent);
    outline-offset: -4px;
  }

  /* ‚îÄ‚îÄ‚îÄ Reading Area ‚îÄ‚îÄ‚îÄ */
  #reader {
    display: none;
    min-height: calc(100dvh - 60px);
    padding-bottom: max(80px, env(safe-area-inset-bottom));
  }

  #content {
    max-width: var(--measure);
    margin: 0 auto;
    padding: 40px 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ Typography ‚îÄ‚îÄ‚îÄ */

  /* Headings */
  #content h1, #content h2, #content h3,
  #content h4, #content h5, #content h6 {
    font-family: var(--font-display);
    color: var(--ink);
    line-height: var(--leading-tight);
    letter-spacing: -0.02em;
    margin-top: 2.5em;
    margin-bottom: 0.6em;
    font-weight: 700;
  }

  #content h1 {
    font-size: clamp(1.75rem, 5vw, var(--text-4xl));
    font-weight: 900;
    letter-spacing: -0.04em;
    line-height: 1.1;
    margin-top: 0;
    margin-bottom: 0.4em;
  }

  #content h2 {
    font-size: clamp(1.4rem, 3.5vw, var(--text-3xl));
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
    margin-top: 2.5em;
  }

  #content h3 { font-size: clamp(1.15rem, 3vw, var(--text-2xl)); }
  #content h4 { font-size: var(--text-xl); font-weight: 600; }
  #content h5 { font-size: var(--text-lg); font-weight: 600; font-style: italic; }
  #content h6 {
    font-size: var(--text-base);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--ink-muted);
  }

  /* Paragraphs */
  #content p {
    margin-bottom: 1.4em;
    hanging-punctuation: first last;
    orphans: 3;
    widows: 3;
  }

  /* First paragraph after heading ‚Äî no indent needed */
  #content h1 + p,
  #content h2 + p,
  #content h3 + p,
  #content h4 + p { }

  /* Drop cap for first paragraph after h1 */
  #content h1 + p::first-letter {
    float: left;
    font-family: var(--font-display);
    font-size: 3.8em;
    font-weight: 900;
    line-height: 0.75;
    margin: 0.08em 0.12em 0 0;
    color: var(--accent);
  }

  /* Links */
  #content a {
    color: var(--accent);
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 3px;
    transition: color var(--transition);
  }
  #content a:hover { color: var(--accent-warm); }

  /* Strong & Em */
  #content strong { font-weight: 600; color: var(--ink); }
  #content em { font-style: italic; }

  /* Blockquote */
  #content blockquote {
    margin: 2em 0;
    padding: 0 0 0 1.5em;
    border-left: 3px solid var(--accent);
    font-style: italic;
    color: var(--ink-soft);
    font-size: 1.05em;
    line-height: var(--leading-relaxed);
  }

  #content blockquote p { margin-bottom: 0.6em; }
  #content blockquote p:last-child { margin-bottom: 0; }

  /* Nested blockquote */
  #content blockquote blockquote {
    border-left-color: var(--ink-faint);
    font-size: 0.95em;
    margin: 0.8em 0;
  }

  /* Horizontal Rule */
  #content hr {
    border: none;
    text-align: center;
    margin: 3em 0;
    color: var(--ink-faint);
    font-size: 1.2em;
    letter-spacing: 0.5em;
  }
  #content hr::after { content: '¬∑ ¬∑ ¬∑'; }

  /* Lists */
  #content ul, #content ol {
    padding-left: 1.5em;
    margin-bottom: 1.4em;
  }

  #content li {
    margin-bottom: 0.4em;
    line-height: var(--leading-normal);
  }

  #content li::marker { color: var(--accent); }

  #content ol { counter-reset: list; }
  #content ol > li { list-style: decimal; }

  #content ul ul, #content ol ol,
  #content ul ol, #content ol ul {
    margin-top: 0.4em;
    margin-bottom: 0.2em;
  }

  /* Task lists */
  #content li input[type="checkbox"] {
    accent-color: var(--accent);
    margin-right: 8px;
    width: 16px;
    height: 16px;
  }

  /* Tables */
  #content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2em 0;
    font-size: var(--text-sm);
    overflow-x: auto;
    display: block;
  }

  #content thead { border-bottom: 2px solid var(--ink); }
  #content th {
    text-align: left;
    padding: 10px 16px;
    font-weight: 600;
    font-family: var(--font-body);
    letter-spacing: 0.03em;
    white-space: nowrap;
  }

  #content td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }

  #content tbody tr:last-child td { border-bottom: none; }
  #content tbody tr:hover { background: var(--paper-dark); }

  /* Code ‚Äî Inline */
  #content code:not(pre code) {
    font-family: var(--font-mono);
    font-size: 0.82em;
    background: var(--code-bg);
    color: var(--accent);
    padding: 0.15em 0.45em;
    border-radius: 3px;
    letter-spacing: -0.01em;
    border: 1px solid var(--border);
  }

  /* Code ‚Äî Block */
  #content pre {
    background: var(--paper-dark);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    overflow-x: auto;
    margin: 1.8em 0;
    position: relative;
  }

  #content pre code {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    line-height: 1.7;
    background: none;
    padding: 0;
    border: none;
    letter-spacing: 0;
  }

  /* Syntax highlight tweaks for light theme */
  [data-theme="light"] .hljs { background: transparent; }
  [data-theme="dark"] .hljs { background: transparent; color: #c9d1d9; }
  [data-theme="dark"] .hljs-keyword { color: #ff7b72; }
  [data-theme="dark"] .hljs-string { color: #a5d6ff; }
  [data-theme="dark"] .hljs-comment { color: #8b949e; font-style: italic; }
  [data-theme="dark"] .hljs-number { color: #f2cc60; }
  [data-theme="dark"] .hljs-function { color: #d2a8ff; }
  [data-theme="dark"] .hljs-built_in { color: #ffa657; }
  [data-theme="dark"] .hljs-attr { color: #79c0ff; }

  /* Copy button on code blocks */
  .code-wrapper { position: relative; }
  .copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 10px;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--ink-muted);
    cursor: pointer;
    opacity: 0;
    transition: opacity var(--transition);
    letter-spacing: 0.05em;
  }

  .code-wrapper:hover .copy-btn,
  .code-wrapper:focus-within .copy-btn { opacity: 1; }
  .copy-btn.copied { color: var(--accent); }

  /* Language label */
  .code-lang {
    position: absolute;
    top: 10px;
    left: 16px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--ink-faint);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    pointer-events: none;
  }

  /* Mermaid diagrams */
  .mermaid {
    background: var(--paper-dark);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    margin: 1.8em 0;
    overflow-x: auto;
    text-align: center;
  }

  .mermaid svg { max-width: 100%; height: auto; }

  /* Images */
  #content img {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 1.5em 0;
    display: block;
  }

  /* Image captions (alt text via figcaption) */
  #content figure {
    margin: 2em 0;
    text-align: center;
  }

  #content figcaption {
    font-size: var(--text-xs);
    color: var(--ink-muted);
    margin-top: 0.6em;
    font-style: italic;
  }

  /* Footnotes */
  #content .footnotes {
    margin-top: 3em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
    font-size: var(--text-sm);
    color: var(--ink-soft);
  }

  /* Definition lists */
  #content dt {
    font-weight: 600;
    margin-top: 1em;
  }
  #content dd {
    padding-left: 1.5em;
    color: var(--ink-soft);
  }

  /* Metadata line (auto-detected frontmatter) */
  .doc-meta {
    font-size: var(--text-sm);
    color: var(--ink-muted);
    margin-bottom: 2em;
    padding-bottom: 1.5em;
    border-bottom: 1px solid var(--border);
    font-style: italic;
  }

  /* ‚îÄ‚îÄ‚îÄ Reading Progress ‚îÄ‚îÄ‚îÄ */
  #progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 2px;
    background: var(--accent);
    width: 0%;
    z-index: 200;
    transition: width 100ms linear;
  }

  /* ‚îÄ‚îÄ‚îÄ Font Size Controls (slide-up panel) ‚îÄ‚îÄ‚îÄ */
  #settings-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--paper);
    border-top: 1px solid var(--border);
    padding: 20px 24px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
    transform: translateY(100%);
    transition: transform 300ms cubic-bezier(0.32, 0.72, 0, 1);
    z-index: 150;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -8px 32px var(--shadow);
  }

  #settings-panel.open { transform: translateY(0); }

  .settings-handle {
    width: 36px;
    height: 4px;
    background: var(--ink-faint);
    border-radius: 2px;
    margin: 0 auto 20px;
  }

  .settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .settings-label {
    font-size: var(--text-sm);
    color: var(--ink-muted);
    font-style: italic;
  }

  .settings-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .size-btn {
    width: 36px;
    height: 36px;
    border: 1px solid var(--border);
    background: var(--paper-dark);
    color: var(--ink);
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background var(--transition);
    -webkit-tap-highlight-color: transparent;
  }

  .size-btn:active { background: var(--border); }
  .size-value {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--ink-muted);
    width: 40px;
    text-align: center;
  }

  .theme-toggle-row {
    display: flex;
    gap: 8px;
  }

  .theme-btn {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: var(--font-body);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition);
    -webkit-tap-highlight-color: transparent;
  }

  .theme-btn.active {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
  }

  .theme-btn:not(.active) {
    background: var(--paper-dark);
    color: var(--ink-muted);
  }

  /* Line width slider */
  .width-slider {
    width: 100%;
    accent-color: var(--accent);
    margin-top: 4px;
  }

  /* Font choice */
  .font-row {
    display: flex;
    gap: 8px;
  }

  .font-btn {
    flex: 1;
    padding: 10px 6px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition);
    background: var(--paper-dark);
    color: var(--ink-muted);
    -webkit-tap-highlight-color: transparent;
  }

  .font-btn.active {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
  }

  /* ‚îÄ‚îÄ‚îÄ Overlay for settings ‚îÄ‚îÄ‚îÄ */
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
    z-index: 140;
  }

  #overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* ‚îÄ‚îÄ‚îÄ ToC Panel ‚îÄ‚îÄ‚îÄ */
  #toc-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: min(320px, 85vw);
    background: var(--paper);
    border-left: 1px solid var(--border);
    padding: 0;
    transform: translateX(100%);
    transition: transform 300ms cubic-bezier(0.32, 0.72, 0, 1);
    z-index: 150;
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  #toc-panel.open { transform: translateX(0); }

  .toc-header {
    position: sticky;
    top: 0;
    background: var(--paper);
    padding: 20px 20px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .toc-title {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  #toc-list {
    padding: 12px 0 40px;
    list-style: none;
  }

  .toc-item a {
    display: block;
    padding: 6px 20px;
    color: var(--ink-soft);
    text-decoration: none;
    font-size: var(--text-sm);
    line-height: var(--leading-snug);
    transition: color var(--transition), background var(--transition);
    border-left: 2px solid transparent;
  }

  .toc-item a:hover {
    color: var(--ink);
    background: var(--paper-dark);
  }

  .toc-item.active a {
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 500;
  }

  .toc-item.level-1 a { padding-left: 20px; font-weight: 500; }
  .toc-item.level-2 a { padding-left: 32px; }
  .toc-item.level-3 a { padding-left: 44px; font-size: 0.8rem; }
  .toc-item.level-4 a, .toc-item.level-5 a, .toc-item.level-6 a {
    padding-left: 56px;
    font-size: 0.8rem;
    color: var(--ink-muted);
  }

  /* ‚îÄ‚îÄ‚îÄ Scroll-to-top ‚îÄ‚îÄ‚îÄ */
  #scroll-top {
    position: fixed;
    bottom: max(28px, env(safe-area-inset-bottom, 20px));
    right: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--ink);
    color: var(--paper);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity var(--transition), transform var(--transition);
    z-index: 90;
    box-shadow: 0 4px 12px var(--shadow);
    -webkit-tap-highlight-color: transparent;
  }

  #scroll-top.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* ‚îÄ‚îÄ‚îÄ Error state ‚îÄ‚îÄ‚îÄ */
  .error-msg {
    background: rgba(200, 50, 30, 0.08);
    border: 1px solid rgba(200, 50, 30, 0.3);
    border-radius: 8px;
    padding: 16px 20px;
    color: #c8321e;
    font-size: var(--text-sm);
    margin: 1em 0;
  }

  /* ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ */
  .loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--ink-muted);
    font-size: var(--text-sm);
    padding: 40px;
  }

  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ‚îÄ Print Styles ‚îÄ‚îÄ‚îÄ */
  @media print {
    #topbar, #settings-panel, #toc-panel, #scroll-top, #progress-bar,
    #annotation-toolbar, #comment-popover, #ann-detail, #toast { display: none !important; }
    body { background: white; color: black; }
    #content { max-width: none; padding: 0; }
  }

  /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
  @media (min-width: 768px) {
    #content { padding: 60px 40px; }
    #topbar { padding: 14px 40px; }
    .toolbar-btn { width: 40px; height: 40px; }
  }

  /* ‚îÄ‚îÄ‚îÄ Animations ‚îÄ‚îÄ‚îÄ */
  #content { animation: fadeIn 350ms ease; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Highlighted anchor target */
  :target { scroll-margin-top: 80px; }

  /* ‚îÄ‚îÄ‚îÄ Annotations ‚îÄ‚îÄ‚îÄ */
  #annotation-toolbar {
    position: fixed;
    display: none;
    z-index: 200;
    background: var(--ink);
    border-radius: 8px;
    padding: 4px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  }

  #annotation-toolbar.visible { display: flex; }

  .ann-tb-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border: none;
    background: none;
    color: var(--paper);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }

  .ann-tb-btn:hover, .ann-tb-btn:active { background: rgba(255,255,255,0.15); }
  .ann-tb-btn + .ann-tb-btn { border-left: 1px solid rgba(255,255,255,0.15); }

  .ann-strikethrough {
    text-decoration: line-through;
    text-decoration-color: rgba(220, 50, 30, 0.7);
    text-decoration-thickness: 2px;
    background: rgba(220, 50, 30, 0.06);
    cursor: pointer;
  }

  .ann-comment {
    background: rgba(255, 180, 0, 0.2);
    border-bottom: 2px solid rgba(220, 160, 0, 0.5);
    cursor: pointer;
  }

  #comment-popover {
    position: fixed;
    display: none;
    z-index: 210;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 8px 32px var(--shadow);
    width: min(320px, calc(100vw - 32px));
  }

  #comment-popover.visible { display: block; }

  #comment-text {
    width: 100%;
    min-height: 80px;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--paper-dark);
    color: var(--ink);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    line-height: var(--leading-normal);
    resize: vertical;
    outline: none;
  }

  #comment-text:focus { border-color: var(--accent); }

  .comment-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 8px;
  }

  .comment-save, .comment-cancel {
    padding: 7px 16px;
    border-radius: 100px;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 600;
    cursor: pointer;
    border: none;
    -webkit-tap-highlight-color: transparent;
    letter-spacing: 0.02em;
  }

  .comment-save { background: var(--accent); color: white; }
  .comment-cancel { background: var(--paper-dark); color: var(--ink-muted); border: 1px solid var(--border); }

  #ann-detail {
    position: fixed;
    display: none;
    z-index: 210;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    box-shadow: 0 8px 32px var(--shadow);
    max-width: min(320px, calc(100vw - 32px));
  }

  #ann-detail.visible { display: block; }

  .ann-detail-text {
    color: var(--ink-muted);
    font-size: var(--text-sm);
    font-style: italic;
    line-height: var(--leading-snug);
    margin-bottom: 8px;
  }

  .ann-detail-comment {
    color: var(--ink);
    font-size: var(--text-sm);
    line-height: var(--leading-snug);
    margin-bottom: 10px;
    padding: 8px 10px;
    background: rgba(255, 180, 0, 0.1);
    border-radius: 6px;
  }

  .ann-delete-btn {
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 100px;
    background: var(--paper-dark);
    color: var(--ink-muted);
    font-size: var(--text-xs);
    font-family: var(--font-body);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }

  #toast {
    position: fixed;
    bottom: max(80px, calc(env(safe-area-inset-bottom, 20px) + 20px));
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--ink);
    color: var(--paper);
    padding: 10px 24px;
    border-radius: 100px;
    font-size: var(--text-sm);
    font-family: var(--font-body);
    opacity: 0;
    transition: opacity 200ms ease, transform 200ms ease;
    z-index: 300;
    pointer-events: none;
    white-space: nowrap;
  }

  #toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body data-theme="light">

<div id="progress-bar"></div>

<!-- Top bar -->
<header id="topbar">
  <span id="app-title"></span>

  <button class="toolbar-btn" id="btn-open" title="Open file" onclick="openFile()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 4h6l2 3h8a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1z"/>
    </svg>
  </button>

  <button class="toolbar-btn" id="btn-toc" title="Table of contents" onclick="toggleToc()" style="display:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/>
    </svg>
  </button>

  <button class="toolbar-btn" id="btn-note" title="Add a note" onclick="startDocNote()" style="display:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/>
    </svg>
  </button>

  <button class="toolbar-btn" id="btn-export" title="Export annotations" onclick="exportAnnotations()" style="display:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
    </svg>
  </button>

  <button class="toolbar-btn" id="btn-clear" title="Clear annotations" onclick="clearAnnotations()" style="display:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/>
    </svg>
  </button>

  <button class="toolbar-btn" id="btn-settings" title="Settings" onclick="toggleSettings()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </button>
</header>

<!-- Drop zone -->
<main id="dropzone">
  <div class="drop-icon">üìñ</div>
  <h1 class="drop-title" id="dropzone-heading">Drop a Markdown file or folder</h1>
  <p class="drop-sub" id="dropzone-sub">Or paste a URL below ‚Äî works offline, nothing leaves your device</p>

  <button class="drop-btn" onclick="openFile()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    Choose File
  </button>

  <div class="drop-divider">or load from URL</div>

  <div class="drop-url-row">
    <input class="url-input" id="url-input" type="url" placeholder="https://raw.githubusercontent.com/‚Ä¶" />
    <button class="url-go" onclick="loadFromUrl()">Go</button>
  </div>
</main>

<!-- Reader -->
<div id="reader">
  <article id="content"></article>
</div>

<!-- Scroll to top -->
<button id="scroll-top" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Back to top">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
</button>

<!-- Settings panel -->
<div id="overlay" onclick="closeAll()"></div>

<div id="settings-panel">
  <div class="settings-handle"></div>

  <div class="settings-row">
    <span class="settings-label">Font size</span>
    <div class="settings-controls">
      <button class="size-btn" onclick="adjustSize(-1)">A‚àí</button>
      <span class="size-value" id="size-display">18</span>
      <button class="size-btn" onclick="adjustSize(1)">A+</button>
    </div>
  </div>

  <div class="settings-row">
    <span class="settings-label">Line width</span>
    <div class="settings-controls" style="flex:1; margin-left:16px;">
      <input type="range" class="width-slider" id="width-slider" min="45" max="85" value="68" oninput="adjustWidth(this.value)">
    </div>
  </div>

  <div class="settings-row">
    <span class="settings-label">Font</span>
    <div class="font-row" style="flex:1; margin-left:16px; gap:6px;">
      <button class="font-btn active" onclick="setFont('lora', this)" style="font-family:'Lora',serif">Lora</button>
      <button class="font-btn" onclick="setFont('georgia', this)" style="font-family:Georgia,serif">Georgia</button>
      <button class="font-btn" onclick="setFont('system', this)" style="font-family:-apple-system,sans-serif">Sans</button>
    </div>
  </div>

  <div class="settings-row" style="margin-bottom:0;">
    <span class="settings-label">Theme</span>
    <div class="theme-toggle-row" style="flex:1; margin-left:16px; gap:6px;">
      <button class="theme-btn active" id="btn-light" onclick="setTheme('light')">‚òÄ Light</button>
      <button class="theme-btn" id="btn-sepia" onclick="setTheme('sepia')">‚óë Sepia</button>
      <button class="theme-btn" id="btn-dark" onclick="setTheme('dark')">‚òæ Dark</button>
    </div>
  </div>
</div>

<!-- ToC panel -->
<div id="toc-panel">
  <div class="toc-header">
    <span class="toc-title">Contents</span>
    <button class="toolbar-btn" onclick="toggleToc()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <ul id="toc-list"></ul>
</div>

<input type="file" id="file-input" accept=".md,.markdown,.txt" style="display:none" onchange="handleFile(this.files[0])">

<!-- Annotation toolbar -->
<div id="annotation-toolbar" onpointerdown="event.preventDefault()">
  <button class="ann-tb-btn" onclick="addStrikethrough()" title="Strike through">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/><path d="M16 7c0-2-2-3-4-3s-4 1-4 3c0 2 3 3 4 3"/><path d="M8 17c0 2 2 3 4 3s4-1 4-3c0-2-3-3-4-3"/></svg>
    Strike
  </button>
  <button class="ann-tb-btn" onclick="startComment()" title="Add comment">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    Comment
  </button>
</div>

<!-- Comment input -->
<div id="comment-popover">
  <textarea id="comment-text" placeholder="Add your note‚Ä¶"></textarea>
  <div class="comment-actions">
    <button class="comment-cancel" onclick="cancelComment()">Cancel</button>
    <button class="comment-save" onclick="saveComment()">Save</button>
  </div>
</div>

<!-- Annotation detail popover -->
<div id="ann-detail">
  <div class="ann-detail-text" id="ann-detail-text"></div>
  <div class="ann-detail-comment" id="ann-detail-comment"></div>
  <button class="ann-delete-btn" onclick="removeAnnotation()">Remove</button>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let fontSize = parseInt(localStorage.getItem('reader-fontsize') || '18');
let currentTheme = localStorage.getItem('reader-theme') || 'light';
let currentFont = localStorage.getItem('reader-font') || 'lora';
let measureWidth = parseInt(localStorage.getItem('reader-width') || '68');

// ‚îÄ‚îÄ‚îÄ Document Source ‚îÄ‚îÄ‚îÄ
let currentDocSource = ''; // URL or filename

// ‚îÄ‚îÄ‚îÄ Annotation State ‚îÄ‚îÄ‚îÄ
let annotations = [];
let annotationCounter = 0;
let originalMarkdownText = '';
let savedRange = null;
let activeAnnotationId = null;

// ‚îÄ‚îÄ‚îÄ Folder State ‚îÄ‚îÄ‚îÄ
let folderFiles = {}; // path ‚Üí markdown text
let currentFolderFile = '';

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  applyFont(currentFont, false);
  applyTheme(currentTheme, false);
  applySize(fontSize, false);
  applyWidth(measureWidth, false);
  document.getElementById('size-display').textContent = fontSize;
  document.getElementById('width-slider').value = measureWidth;

  // Check URL param ?url=... or #filename hash
  const params = new URLSearchParams(location.search);
  if (params.has('url')) {
    fetchMarkdown(params.get('url'));
  } else if (location.hash.length > 1) {
    const filename = decodeURIComponent(location.hash.slice(1));
    document.getElementById('dropzone-heading').textContent =
      'You were reading ' + filename;
    document.getElementById('dropzone-sub').textContent =
      'Drop the file again to continue';
  }

  // Mermaid init
  mermaid.initialize({
    startOnLoad: false,
    theme: currentTheme === 'dark' ? 'dark' : 'default',
    fontFamily: 'Lora, Georgia, serif',
    fontSize: 14,
  });

  setupDragDrop();
  setupScroll();
  setupAnnotations();
});

// ‚îÄ‚îÄ‚îÄ File Handling ‚îÄ‚îÄ‚îÄ
function openFile() {
  document.getElementById('file-input').click();
}

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    currentDocSource = file.name;
    history.replaceState(null, '', '#' + encodeURIComponent(file.name));
    renderMarkdown(e.target.result, file.name);
  };
  reader.onerror = () => showError('Could not read the file.');
  reader.readAsText(file);
}

async function handleFolder(dirEntry) {
  showLoading();
  folderFiles = {};
  currentFolderFile = '';

  async function readDir(entry, path = '') {
    const reader = entry.createReader();
    const entries = await new Promise((resolve, reject) => {
      const all = [];
      (function read() {
        reader.readEntries(results => {
          if (!results.length) return resolve(all);
          all.push(...results);
          read();
        }, reject);
      })();
    });

    for (const e of entries) {
      const ePath = path ? path + '/' + e.name : e.name;
      if (e.isDirectory) {
        await readDir(e, ePath);
      } else if (e.isFile && /\.(md|markdown|txt)$/i.test(e.name)) {
        const file = await new Promise(r => e.file(r));
        const text = await file.text();
        folderFiles[ePath] = text;
      }
    }
  }

  await readDir(dirEntry);
  const paths = Object.keys(folderFiles).sort();
  if (!paths.length) {
    showLoading(false);
    showError('No markdown files found in folder.');
    return;
  }

  // Pick starting file: README.md, index.md, or first alphabetically
  const start = paths.find(p => /^readme\.md$/i.test(p.split('/').pop()))
    || paths.find(p => /^index\.md$/i.test(p.split('/').pop()))
    || paths[0];

  currentDocSource = dirEntry.name + '/' + start;
  history.replaceState(
    { folderFile: start, inFolder: true },
    '',
    '#' + encodeURIComponent(start.split('/').pop())
  );
  loadFolderFile(start, false);
}

function loadFolderFile(path, push = true) {
  const text = folderFiles[path];
  if (!text) return;
  currentFolderFile = path;
  currentDocSource = path;
  if (push) {
    history.pushState(
      { folderFile: path, inFolder: true },
      '',
      '#' + encodeURIComponent(path.split('/').pop())
    );
  }
  renderMarkdown(text, path.split('/').pop());
  setupFolderLinks();
}

function setupFolderLinks() {
  if (!Object.keys(folderFiles).length) return;
  document.querySelectorAll('#content a[href]').forEach(a => {
    const href = a.getAttribute('href');
    if (!href || href.startsWith('http') || href.startsWith('#')) return;

    // Resolve relative path
    const base = currentFolderFile.includes('/')
      ? currentFolderFile.substring(0, currentFolderFile.lastIndexOf('/') + 1)
      : '';
    const resolved = normalizePath(base + href);

    if (folderFiles[resolved]) {
      a.addEventListener('click', e => {
        e.preventDefault();
        loadFolderFile(resolved);
        window.scrollTo(0, 0);
      });
      a.style.cursor = 'pointer';
    }
  });
}

function normalizePath(path) {
  const parts = [];
  for (const p of path.split('/')) {
    if (p === '..') parts.pop();
    else if (p && p !== '.') parts.push(p);
  }
  return parts.join('/');
}

function loadFromUrl() {
  const url = document.getElementById('url-input').value.trim();
  if (!url) return;
  fetchMarkdown(url);
}

async function fetchMarkdown(url) {
  showLoading();
  try {
    // Handle GitHub blob URLs ‚Üí raw
    const rawUrl = url
      .replace('github.com', 'raw.githubusercontent.com')
      .replace('/blob/', '/');

    const res = await fetch(rawUrl);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const filename = url.split('/').pop() || 'document.md';
    currentDocSource = url;
    history.replaceState(null, '', '?url=' + encodeURIComponent(url));
    renderMarkdown(text, filename);
  } catch (e) {
    showLoading(false);
    showError(`Could not load URL: ${e.message}. Note: the server must allow cross-origin requests.`);
  }
}

function showLoading(show = true) {
  const content = document.getElementById('content');
  if (show) {
    showReader();
    content.innerHTML = `<div class="loading-spinner"><div class="spinner"></div> Loading‚Ä¶</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ Markdown Rendering ‚îÄ‚îÄ‚îÄ
function renderMarkdown(text, filename = 'document') {
  originalMarkdownText = text;
  annotations = [];
  annotationCounter = 0;
  updateExportButton();

  // Extract frontmatter
  let meta = null;
  let body = text;
  const fmMatch = text.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
  if (fmMatch) {
    meta = parseFrontmatter(fmMatch[1]);
    body = fmMatch[2];
  }

  // Configure marked
  marked.setOptions({
    gfm: true,
    breaks: false,
    headerIds: true,
    mangle: false,
  });

  // Pre-process: detect mermaid fences
  const processed = body.replace(/```mermaid\n([\s\S]*?)```/g, (_, diagram) => {
    const id = 'mermaid-' + Math.random().toString(36).slice(2);
    return `<div class="mermaid" id="${id}">${diagram.trim()}</div>`;
  });

  let html = marked.parse(processed);

  // Post-process: wrap pre blocks with copy button
  html = html.replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g, (match, attrs, code) => {
    const langMatch = attrs.match(/class="language-(\w+)"/);
    const lang = langMatch ? langMatch[1] : '';
    const id = 'code-' + Math.random().toString(36).slice(2);
    return `<div class="code-wrapper">
      ${lang ? `<span class="code-lang">${lang}</span>` : ''}
      <button class="copy-btn" onclick="copyCode('${id}')">Copy</button>
      <pre><code${attrs} id="${id}">${code}</code></pre>
    </div>`;
  });

  // Set title
  const titleFromMeta = meta?.title;
  const titleFromH1 = body.match(/^#\s+(.+)/m)?.[1];
  const docTitle = titleFromMeta || titleFromH1 || filename.replace(/\.(md|markdown)$/, '');
  document.getElementById('app-title').textContent = docTitle;
  document.title = docTitle + ' ‚Äî Reader';

  const content = document.getElementById('content');

  // Render meta block
  let metaHtml = '';
  if (meta) {
    const parts = [];
    if (meta.date) parts.push(formatDate(meta.date));
    if (meta.author) parts.push('by ' + meta.author);
    if (meta.tags) parts.push(Array.isArray(meta.tags) ? meta.tags.join(', ') : meta.tags);
    if (parts.length) metaHtml = `<div class="doc-meta">${parts.join(' ¬∑ ')}</div>`;
  }

  content.innerHTML = metaHtml + html;

  // Syntax highlighting ‚Äî only highlight blocks with an explicit language tag
  content.querySelectorAll('pre code[class*="language-"]').forEach(el => hljs.highlightElement(el));

  // Mermaid
  mermaid.initialize({
    startOnLoad: false,
    theme: currentTheme === 'dark' ? 'dark' : 'default',
  });
  mermaid.run({ nodes: content.querySelectorAll('.mermaid') });

  // Make task list checkboxes interactive
  content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.disabled = false;
    cb.addEventListener('change', () => {
      const li = cb.closest('li');
      const text = li ? li.textContent.trim() : '';
      const id = 'ann-' + (++annotationCounter);
      if (cb.checked) {
        annotations.push({ id, type: 'checkbox', text, comment: null });
        li.style.textDecoration = 'line-through';
        li.style.opacity = '0.6';
      } else {
        // Uncheck: remove the checkbox annotation for this text
        annotations = annotations.filter(a => !(a.type === 'checkbox' && a.text === text));
        li.style.textDecoration = '';
        li.style.opacity = '';
      }
      updateExportButton();
      saveAnnotations();
    });
  });

  // Build ToC
  buildToc(content);

  // Set document title in topbar
  document.getElementById('app-title').style.display = '';

  // Restore saved annotations
  loadAnnotations();

  showReader();
  window.scrollTo(0, 0);
}

function parseFrontmatter(yaml) {
  const result = {};
  yaml.split('\n').forEach(line => {
    const m = line.match(/^(\w+):\s*(.+)$/);
    if (m) {
      let val = m[2].trim().replace(/^["']|["']$/g, '');
      if (val.startsWith('[')) {
        try { val = JSON.parse(val); } catch(_) {}
      }
      result[m[1]] = val;
    }
  });
  return result;
}

function formatDate(str) {
  try {
    return new Date(str).toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'});
  } catch(_) { return str; }
}

// ‚îÄ‚îÄ‚îÄ ToC ‚îÄ‚îÄ‚îÄ
function buildToc(content) {
  const headings = content.querySelectorAll('h1,h2,h3,h4,h5,h6');
  const tocList = document.getElementById('toc-list');
  const tocBtn = document.getElementById('btn-toc');

  if (headings.length < 2) {
    tocBtn.style.display = 'none';
    tocList.innerHTML = '';
    return;
  }

  tocBtn.style.display = '';
  tocList.innerHTML = '';

  headings.forEach((h, i) => {
    const id = h.id || 'heading-' + i;
    h.id = id;
    const level = parseInt(h.tagName[1]);
    const li = document.createElement('li');
    li.className = `toc-item level-${level}`;
    li.dataset.id = id;
    const a = document.createElement('a');
    a.href = '#' + id;
    a.textContent = h.textContent;
    a.onclick = () => { toggleToc(); };
    li.appendChild(a);
    tocList.appendChild(li);
  });
}

// ‚îÄ‚îÄ‚îÄ UI State ‚îÄ‚îÄ‚îÄ
function showReader() {
  document.getElementById('dropzone').style.display = 'none';
  document.getElementById('reader').style.display = 'block';
  document.getElementById('btn-note').style.display = '';
}

function showDropzone() {
  document.getElementById('dropzone').style.display = 'flex';
  document.getElementById('reader').style.display = 'none';
  document.getElementById('btn-toc').style.display = 'none';
  document.getElementById('btn-note').style.display = 'none';
  document.getElementById('app-title').style.display = 'none';
  document.getElementById('dropzone-heading').textContent = 'Drop a Markdown file or folder';
  document.getElementById('dropzone-sub').textContent =
    'Or paste a URL below \u2014 works offline, nothing leaves your device';
  document.title = 'Reader';
  currentDocSource = '';
  folderFiles = {};
  currentFolderFile = '';
  history.replaceState(null, '', location.pathname);
  annotations = [];
  annotationCounter = 0;
  originalMarkdownText = '';
  updateExportButton();
}

function showError(msg) {
  const content = document.getElementById('content');
  content.innerHTML = `<div class="error-msg">‚ö† ${msg}</div><p style="margin-top:1em"><button class="drop-btn" onclick="showDropzone()">‚Üê Back</button></p>`;
  showReader();
}

// ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ
function toggleSettings() {
  const p = document.getElementById('settings-panel');
  const o = document.getElementById('overlay');
  const isOpen = p.classList.contains('open');
  closeAll();
  if (!isOpen) {
    p.classList.add('open');
    o.classList.add('visible');
  }
}

function toggleToc() {
  const p = document.getElementById('toc-panel');
  const o = document.getElementById('overlay');
  const isOpen = p.classList.contains('open');
  closeAll();
  if (!isOpen) {
    p.classList.add('open');
    o.classList.add('visible');
  }
}

function closeAll() {
  document.getElementById('settings-panel').classList.remove('open');
  document.getElementById('toc-panel').classList.remove('open');
  document.getElementById('overlay').classList.remove('visible');
  document.getElementById('annotation-toolbar').classList.remove('visible');
  document.getElementById('comment-popover').classList.remove('visible');
  document.getElementById('ann-detail').classList.remove('visible');
}

// ‚îÄ‚îÄ‚îÄ Font Size ‚îÄ‚îÄ‚îÄ
function adjustSize(delta) {
  fontSize = Math.min(28, Math.max(13, fontSize + delta));
  applySize(fontSize);
  document.getElementById('size-display').textContent = fontSize;
  localStorage.setItem('reader-fontsize', fontSize);
}

function applySize(size, save = true) {
  document.documentElement.style.setProperty('--text-base', size + 'px');
  if (save) localStorage.setItem('reader-fontsize', size);
}

// ‚îÄ‚îÄ‚îÄ Line Width ‚îÄ‚îÄ‚îÄ
function adjustWidth(val) {
  applyWidth(parseInt(val));
  localStorage.setItem('reader-width', val);
}

function applyWidth(val, save = true) {
  document.documentElement.style.setProperty('--measure', val + 'ch');
  if (save) localStorage.setItem('reader-width', val);
}

// ‚îÄ‚îÄ‚îÄ Font ‚îÄ‚îÄ‚îÄ
function setFont(font, btn) {
  document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  applyFont(font);
  localStorage.setItem('reader-font', font);
}

function applyFont(font, save = true) {
  const fonts = {
    lora: "'Lora', 'Georgia', serif",
    georgia: "Georgia, 'Times New Roman', serif",
    system: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif",
  };
  document.documentElement.style.setProperty('--font-body', fonts[font] || fonts.lora);
  if (save) localStorage.setItem('reader-font', font);

  // Update active button
  document.querySelectorAll('.font-btn').forEach(b => {
    b.classList.toggle('active', b.getAttribute('onclick').includes("'" + font + "'"));
  });
}

// ‚îÄ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ
function setTheme(theme) {
  applyTheme(theme);
  localStorage.setItem('reader-theme', theme);

  // Reinit mermaid with correct theme
  mermaid.initialize({ theme: theme === 'dark' ? 'dark' : 'default' });
}

function applyTheme(theme, save = true) {
  currentTheme = theme;
  const body = document.body;
  body.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');

  // Sepia overrides
  if (theme === 'sepia') {
    body.style.setProperty('--paper', '#F4ECD8');
    body.style.setProperty('--paper-dark', '#EBE0C6');
    body.style.setProperty('--ink', '#3B2A1A');
    body.style.setProperty('--ink-soft', '#5C3D22');
    body.style.setProperty('--ink-muted', '#8B6845');
    body.style.setProperty('--accent', '#8B4513');
    body.style.setProperty('--code-bg', '#EBE0C6');
    body.style.setProperty('--border', 'rgba(59,42,26,0.15)');
  } else {
    ['--paper','--paper-dark','--ink','--ink-soft','--ink-muted',
     '--accent','--code-bg','--border'].forEach(v => body.style.removeProperty(v));
  }

  // HLjs theme
  const hljsEl = document.getElementById('hljs-theme');
  hljsEl.href = theme === 'dark'
    ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css'
    : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';

  // Theme button states
  ['light','sepia','dark'].forEach(t => {
    const btn = document.getElementById('btn-' + t);
    if (btn) btn.classList.toggle('active', t === theme);
  });

  if (save) localStorage.setItem('reader-theme', theme);
}

// ‚îÄ‚îÄ‚îÄ Copy Code ‚îÄ‚îÄ‚îÄ
function copyCode(id) {
  const el = document.getElementById(id);
  if (!el) return;
  navigator.clipboard.writeText(el.textContent).then(() => {
    const btn = el.closest('.code-wrapper').querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

// ‚îÄ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ
function setupDragDrop() {
  const body = document.body;

  body.addEventListener('dragover', e => {
    e.preventDefault();
    body.classList.add('drag-over');
  });

  body.addEventListener('dragleave', e => {
    if (!e.relatedTarget || e.relatedTarget === document.documentElement) {
      body.classList.remove('drag-over');
    }
  });

  body.addEventListener('drop', async e => {
    e.preventDefault();
    body.classList.remove('drag-over');

    // Check for folder drop
    const items = [...(e.dataTransfer.items || [])];
    const entry = items[0]?.webkitGetAsEntry?.();
    if (entry?.isDirectory) {
      await handleFolder(entry);
      return;
    }

    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });
}

// ‚îÄ‚îÄ‚îÄ Scroll ‚îÄ‚îÄ‚îÄ
function setupScroll() {
  const progressBar = document.getElementById('progress-bar');
  const scrollBtn = document.getElementById('scroll-top');
  const tocItems = () => document.querySelectorAll('.toc-item');

  window.addEventListener('scroll', () => {
    const scrolled = window.scrollY;
    const total = document.documentElement.scrollHeight - window.innerHeight;
    const pct = total > 0 ? (scrolled / total * 100) : 0;
    progressBar.style.width = pct + '%';

    scrollBtn.classList.toggle('visible', scrolled > 400);

    // Update active ToC item
    const headings = document.querySelectorAll('#content h1,#content h2,#content h3,#content h4');
    let active = null;
    headings.forEach(h => {
      if (h.getBoundingClientRect().top <= 100) active = h.id;
    });
    if (active) {
      tocItems().forEach(li => {
        li.classList.toggle('active', li.dataset.id === active);
      });
    }
  }, { passive: true });
}

// ‚îÄ‚îÄ‚îÄ Annotations ‚îÄ‚îÄ‚îÄ
function setupAnnotations() {
  document.addEventListener('mouseup', checkSelectionSoon);
  document.addEventListener('touchend', checkSelectionSoon);

  document.getElementById('content').addEventListener('click', e => {
    const annSpan = e.target.closest('[data-ann-id]');
    if (annSpan) {
      e.preventDefault();
      e.stopPropagation();
      showAnnotationDetail(annSpan.dataset.annId, annSpan);
    }
  });

  document.addEventListener('pointerdown', e => {
    const toolbar = document.getElementById('annotation-toolbar');
    const detail = document.getElementById('ann-detail');
    const commentPop = document.getElementById('comment-popover');
    if (toolbar.contains(e.target) || commentPop.contains(e.target)) return;
    if (!detail.contains(e.target)) hideDetail();
  });

  document.getElementById('comment-text').addEventListener('keydown', e => {
    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      saveComment();
    }
  });
}

let _selTimer;
function checkSelectionSoon() {
  clearTimeout(_selTimer);
  _selTimer = setTimeout(checkSelection, 20);
}

function checkSelection() {
  const sel = window.getSelection();
  if (!sel || sel.isCollapsed || !sel.rangeCount) {
    if (!document.getElementById('comment-popover').classList.contains('visible')) {
      hideAnnotationToolbar();
    }
    return;
  }

  const range = sel.getRangeAt(0);
  const content = document.getElementById('content');
  const ancestor = range.commonAncestorContainer;
  // content.contains(ancestor) handles the normal case.
  // range.intersectsNode(content) handles triple-clicking the last paragraph,
  // where the browser extends endContainer outside #content.
  if (!content.contains(ancestor) && !range.intersectsNode(content)) {
    hideAnnotationToolbar();
    return;
  }

  if (document.getElementById('comment-popover').contains(ancestor)) return;

  showAnnotationToolbar(range);
}

function showAnnotationToolbar(range) {
  const content = document.getElementById('content');
  const clamped = range.cloneRange();
  if (!content.contains(range.endContainer)) {
    clamped.setEnd(content, content.childNodes.length);
  }
  if (!content.contains(range.startContainer)) {
    clamped.setStart(content, 0);
  }
  savedRange = clamped;
  const toolbar = document.getElementById('annotation-toolbar');
  const rect = range.getBoundingClientRect();

  toolbar.style.visibility = 'hidden';
  toolbar.classList.add('visible');
  const tbRect = toolbar.getBoundingClientRect();

  let top = rect.top - tbRect.height - 8;
  let left = rect.left + (rect.width / 2) - (tbRect.width / 2);

  left = Math.max(8, Math.min(left, window.innerWidth - tbRect.width - 8));
  if (top < 60) top = rect.bottom + 8;

  toolbar.style.top = top + 'px';
  toolbar.style.left = left + 'px';
  toolbar.style.visibility = '';
}

function hideAnnotationToolbar() {
  document.getElementById('annotation-toolbar').classList.remove('visible');
}

function addStrikethrough() {
  if (!savedRange) return;
  const id = 'ann-' + (++annotationCounter);
  const text = savedRange.toString();
  const spans = wrapRange(savedRange, 'ann-strikethrough', id);
  if (!spans.length) return;
  annotations.push({ id, type: 'strikethrough', text, comment: null });
  window.getSelection().removeAllRanges();
  savedRange = null;
  hideAnnotationToolbar();
  updateExportButton();
  saveAnnotations();
}

function startComment() {
  if (!savedRange) return;
  hideAnnotationToolbar();

  const popover = document.getElementById('comment-popover');
  const textarea = document.getElementById('comment-text');
  const rect = savedRange.getBoundingClientRect();

  let top = rect.bottom + 8;
  let left = rect.left;
  left = Math.max(8, Math.min(left, window.innerWidth - 330));
  if (top + 160 > window.innerHeight) top = rect.top - 160;

  popover.style.top = top + 'px';
  popover.style.left = left + 'px';
  popover.classList.add('visible');
  textarea.value = '';
  textarea.focus();
}

function saveComment() {
  const textarea = document.getElementById('comment-text');
  const comment = textarea.value.trim();
  if (!comment) return;

  if (_docNoteMode) {
    const id = 'ann-' + (++annotationCounter);
    annotations.push({ id, type: 'note', text: '', comment });
    document.getElementById('comment-popover').classList.remove('visible');
    textarea.placeholder = 'Add your note‚Ä¶';
    _docNoteMode = false;
    updateExportButton();
    saveAnnotations();
    showToast('Note added');
    return;
  }

  if (!savedRange) return;
  const id = 'ann-' + (++annotationCounter);
  const text = savedRange.toString();
  const spans = wrapRange(savedRange, 'ann-comment', id);
  if (!spans.length) return;

  annotations.push({ id, type: 'comment', text, comment });
  window.getSelection().removeAllRanges();
  savedRange = null;
  document.getElementById('comment-popover').classList.remove('visible');
  updateExportButton();
  saveAnnotations();
}

function cancelComment() {
  document.getElementById('comment-popover').classList.remove('visible');
  savedRange = null;
  _docNoteMode = false;
}

let _docNoteMode = false;

function startDocNote() {
  _docNoteMode = true;
  savedRange = null;
  const popover = document.getElementById('comment-popover');
  const textarea = document.getElementById('comment-text');
  popover.style.top = '60px';
  popover.style.left = Math.max(8, (window.innerWidth - 320) / 2) + 'px';
  popover.classList.add('visible');
  textarea.value = '';
  textarea.placeholder = 'Note on the whole document‚Ä¶';
  textarea.focus();
}

function showAnnotationDetail(id, element) {
  const ann = annotations.find(a => a.id === id);
  if (!ann) return;

  activeAnnotationId = id;
  const detail = document.getElementById('ann-detail');
  const detailText = document.getElementById('ann-detail-text');
  const detailComment = document.getElementById('ann-detail-comment');

  const display = ann.text.length > 120 ? ann.text.slice(0, 120) + '‚Ä¶' : ann.text;
  detailText.textContent = '"' + display + '"';

  if (ann.comment) {
    detailComment.textContent = ann.comment;
    detailComment.style.display = '';
  } else {
    detailComment.style.display = 'none';
  }

  const rect = element.getBoundingClientRect();
  detail.style.visibility = 'hidden';
  detail.classList.add('visible');

  const dRect = detail.getBoundingClientRect();
  let top = rect.bottom + 8;
  let left = rect.left;
  left = Math.max(8, Math.min(left, window.innerWidth - dRect.width - 8));
  if (top + dRect.height > window.innerHeight) top = rect.top - dRect.height - 8;

  detail.style.top = top + 'px';
  detail.style.left = left + 'px';
  detail.style.visibility = '';
}

function hideDetail() {
  document.getElementById('ann-detail').classList.remove('visible');
  activeAnnotationId = null;
}

function removeAnnotation() {
  if (!activeAnnotationId) return;
  const id = activeAnnotationId;
  annotations = annotations.filter(a => a.id !== id);

  document.querySelectorAll(`[data-ann-id="${id}"]`).forEach(span => {
    const parent = span.parentNode;
    while (span.firstChild) parent.insertBefore(span.firstChild, span);
    parent.removeChild(span);
    parent.normalize();
  });

  hideDetail();
  updateExportButton();
  saveAnnotations();
}

function updateExportButton() {
  const show = annotations.length > 0;
  document.getElementById('btn-export').style.display = show ? '' : 'none';
  document.getElementById('btn-clear').style.display = show ? '' : 'none';
}

function exportAnnotations() {
  if (!annotations.length) return;

  let output = '<source>\n';
  output += currentDocSource || 'unknown document';
  output += '\n</source>\n\n';
  output += '<annotations>\n';
  annotations.forEach((ann, i) => {
    if (ann.type === 'strikethrough') {
      output += `${i + 1}. [DELETE] "${ann.text}"\n`;
    } else if (ann.type === 'checkbox') {
      output += `${i + 1}. [CHECK] "${ann.text}"\n`;
    } else if (ann.type === 'note') {
      output += `${i + 1}. [NOTE] ${ann.comment}\n`;
    } else {
      output += `${i + 1}. [COMMENT on "${ann.text}"] ${ann.comment}\n`;
    }
  });
  output += '</annotations>\n\n';
  output += 'Please apply these annotations to the source document: remove text marked DELETE, check items marked CHECK, and address the feedback in each COMMENT.\n';

  navigator.clipboard.writeText(output).then(() => {
    showToast('Annotations copied to clipboard');
  }).catch(() => {
    const blob = new Blob([output], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'annotations.txt';
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('Annotations saved to file');
  });
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toast.classList.remove('visible'), 2500);
}

// ‚îÄ‚îÄ‚îÄ Annotation Persistence ‚îÄ‚îÄ‚îÄ
function hashDoc(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = ((h << 5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return 'reader-ann-' + h;
}

function getAnnotationOffset(annId) {
  const content = document.getElementById('content');
  const firstSpan = content.querySelector(`[data-ann-id="${annId}"]`);
  if (!firstSpan) return -1;
  const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT);
  let offset = 0;
  let node;
  while (node = walker.nextNode()) {
    if (firstSpan.contains(node)) return offset;
    offset += node.length;
  }
  return -1;
}

function saveAnnotations() {
  if (!originalMarkdownText) return;
  const key = hashDoc(originalMarkdownText);
  if (!annotations.length) {
    localStorage.removeItem(key);
    return;
  }
  const data = annotations.map(ann => ({
    type: ann.type,
    text: ann.text,
    comment: ann.comment,
    offset: (ann.type === 'checkbox' || ann.type === 'note') ? -1 : getAnnotationOffset(ann.id)
  }));
  localStorage.setItem(key, JSON.stringify(data));
}

function loadAnnotations() {
  const key = hashDoc(originalMarkdownText);
  const stored = localStorage.getItem(key);
  if (!stored) return;

  let data;
  try { data = JSON.parse(stored); } catch(_) { return; }

  const content = document.getElementById('content');
  const fullText = content.textContent;

  data.forEach(ann => {
    const id = 'ann-' + (++annotationCounter);

    if (ann.type === 'note') {
      annotations.push({ id, type: 'note', text: '', comment: ann.comment });
      return;
    }

    if (ann.type === 'checkbox') {
      content.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        const li = cb.closest('li');
        if (li && li.textContent.trim() === ann.text && !cb.checked) {
          cb.checked = true;
          li.style.textDecoration = 'line-through';
          li.style.opacity = '0.6';
        }
      });
      annotations.push({ id, type: 'checkbox', text: ann.text, comment: null });
      return;
    }

    if (ann.offset < 0) return;
    const textAtOffset = fullText.substring(ann.offset, ann.offset + ann.text.length);
    if (textAtOffset !== ann.text) return;

    const range = createRangeFromOffset(ann.offset, ann.text.length);
    if (!range) return;

    const className = ann.type === 'strikethrough' ? 'ann-strikethrough' : 'ann-comment';
    wrapRange(range, className, id);
    annotations.push({ id, type: ann.type, text: ann.text, comment: ann.comment });
  });

  updateExportButton();
}

function createRangeFromOffset(startOffset, length) {
  const content = document.getElementById('content');
  const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT);
  let offset = 0;
  let node;
  const range = document.createRange();
  let startSet = false;

  while (node = walker.nextNode()) {
    const nodeEnd = offset + node.length;
    if (!startSet && nodeEnd > startOffset) {
      range.setStart(node, startOffset - offset);
      startSet = true;
    }
    if (startSet && nodeEnd >= startOffset + length) {
      range.setEnd(node, startOffset + length - offset);
      return range;
    }
    offset = nodeEnd;
  }

  return startSet ? range : null;
}

function clearAnnotations() {
  document.querySelectorAll('[data-ann-id]').forEach(span => {
    const parent = span.parentNode;
    while (span.firstChild) parent.insertBefore(span.firstChild, span);
    parent.removeChild(span);
  });
  // Reset checked checkboxes
  document.querySelectorAll('#content input[type="checkbox"]:checked').forEach(cb => {
    cb.checked = false;
    const li = cb.closest('li');
    if (li) { li.style.textDecoration = ''; li.style.opacity = ''; }
  });
  document.getElementById('content').normalize();

  annotations = [];
  annotationCounter = 0;

  if (originalMarkdownText) {
    localStorage.removeItem(hashDoc(originalMarkdownText));
  }

  updateExportButton();
  hideDetail();
  showToast('Annotations cleared');
}

// ‚îÄ‚îÄ‚îÄ Range Wrapping ‚îÄ‚îÄ‚îÄ
function wrapRange(range, className, annotationId) {
  const textNodes = getTextNodesInRange(range);
  const spans = [];

  for (const { node, start, end } of textNodes) {
    let target = node;
    let targetEnd = end;

    if (start > 0) {
      target = target.splitText(start);
      targetEnd = end - start;
    }
    if (targetEnd < target.length) {
      target.splitText(targetEnd);
    }

    const span = document.createElement('span');
    span.className = className;
    span.dataset.annId = annotationId;
    target.parentNode.insertBefore(span, target);
    span.appendChild(target);
    spans.push(span);
  }

  return spans;
}

function getTextNodesInRange(range) {
  if (range.collapsed) return [];

  // Single text node
  if (range.startContainer === range.endContainer && range.startContainer.nodeType === Node.TEXT_NODE) {
    return [{ node: range.startContainer, start: range.startOffset, end: range.endOffset }];
  }

  const root = range.commonAncestorContainer;
  const rootEl = root.nodeType === Node.TEXT_NODE ? root.parentNode : root;
  const walker = document.createTreeWalker(rootEl, NodeFilter.SHOW_TEXT);
  const result = [];
  let node;

  while (node = walker.nextNode()) {
    if (!range.intersectsNode(node)) {
      if (result.length) break;
      continue;
    }

    let start = 0;
    let end = node.length;
    if (node === range.startContainer) start = range.startOffset;
    if (node === range.endContainer) end = range.endOffset;

    if (start < end) result.push({ node, start, end });
  }

  return result;
}

// ‚îÄ‚îÄ‚îÄ Folder Back/Forward Navigation ‚îÄ‚îÄ‚îÄ
window.addEventListener('popstate', e => {
  if (e.state?.folderFile && folderFiles[e.state.folderFile]) {
    loadFolderFile(e.state.folderFile, false);
    window.scrollTo(0, 0);
  }
});

// ‚îÄ‚îÄ‚îÄ Keyboard Shortcuts ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeAll();
  if ((e.metaKey || e.ctrlKey) && e.key === 'o') { e.preventDefault(); openFile(); }
});

// ‚îÄ‚îÄ‚îÄ URL input enter key ‚îÄ‚îÄ‚îÄ
document.getElementById('url-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') loadFromUrl();
});
</script>

<!-- Service Worker for PWA / offline -->
<script>
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'reader-v1';
    const PRECACHE = [
      'https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@700;900&display=swap',
      'https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js',
    ];

    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE).then(c => c.addAll(PRECACHE).catch(() => {}))
      );
      self.skipWaiting();
    });

    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(keys =>
          Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        )
      );
      self.clients.claim();
    });

    self.addEventListener('fetch', e => {
      if (e.request.method !== 'GET') return;
      e.respondWith(
        caches.match(e.request).then(cached => {
          if (cached) return cached;
          return fetch(e.request).then(res => {
            if (!res || res.status !== 200) return res;
            const clone = res.clone();
            caches.open(CACHE).then(c => c.put(e.request, clone));
            return res;
          }).catch(() => cached);
        })
      );
    });
  `;
  const blob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(() => {});
}
</script>
</body>
</html>
